pipeline {
    agent { none }

    tools {
        maven 'maven'
    }

    environment {
        NAME = 'dibya'       // Environment variables are usually uppercase
    }

    parameters {
        choice choices: ['dev','prod'], name: 'select_environment'
    }

    stages {
        stage('build') {
            steps {
                sh 'mvn clean package -DskipTests=true'
            }
        }

        stage('test') {
            parallel {
                stage('testA') {
                    agent {label 'node1'}
                    steps {
                        echo "This is test A"
                        sh 'mvn test'
                    }
                }
                stage('testB') {
                    agent {label 'node1'}
                    steps {
                        sh 'mvn test'
                        echo "This is test B"
                    }
                }
            }
        }
    }

    post {
        success {
            dir('webapp/target/'){
                stash name: 'maven-build',includes: "*.jar"
            }
        }
    }
    stage('deploy_dev'){
        when{expression {params.select_environment=='dev'} beforeAgent true}
        agent(label 'node1')
        steps{
            dir(
              "/var/www/html"
            )
            unstash "maven-build"
        }
    }
}
